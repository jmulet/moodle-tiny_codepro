{"version":3,"file":"viewdialog.min.js","sources":["../src/viewdialog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {createModal} from \"./modal\";\nimport ModalEvents from 'core/modal_events';\nimport {getPref, setPref} from \"./preferences\";\nimport {getDefaultUI} from \"./options\";\nimport {ViewManager} from \"./viewmanager\";\n\n/**\n * Tiny CodePro plugin.\n *\n * @module      tiny_codepro/plugin\n * @copyright   2023-2025 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nconst dialogQuery = '[role=\"document\"], [data-region=\"modal\"]';\n\nexport class ViewDialogManager extends ViewManager {\n    constructor(editor, opts) {\n        super(editor, opts);\n    }\n    async _tShow() {\n        // Make the modal visible\n        this.modal.show();\n        this._showSpinner(this.modal.body[0]);\n        // Add the codeEditor (CodeMirror) in the selected UI element\n        await this.attachCodeEditor(this.modal.body[0]); // this.codeEditorElement);\n        this._hideSpinner(this.modal.body[0]);\n\n        // Update the two-state icons\n        if (!this.codeEditor._config.lineWrapping) {\n            this.domElements.btnWrap.querySelector('span').innerHTML = ViewManager.icons.rightarrow;\n        }\n        if (this.codeEditor._config.themeName === 'dark') {\n            this.domElements.btnTheme.querySelector('span').innerHTML = ViewManager.icons.moon;\n        }\n    }\n\n    async _tCreate() {\n        const defaultUI = getDefaultUI(this.editor) ?? 'dialog';\n        const canuserswitchui = defaultUI.startsWith('user:');\n\n        const data = {\n            elementid: Math.random().toString(32).substring(2),\n            canuserswitchui,\n            icons: ViewManager.icons\n        };\n\n        // Show modal with buttons.\n        const modal = await createModal({\n            templateContext: data,\n        });\n        this.modal = modal;\n\n        this.codeEditorElement = modal.body[0];\n\n        modal.getRoot().find(\".modal-dialog.modal-lg\").addClass(\"tiny_codepro-dlg\");\n        // Disable keyboard events (ESC key) on this modal\n        modal.getRoot().off('keydown');\n        // Prevent modal from closing on outside clicks\n        modal.getRoot().on(ModalEvents.outsideClick, (evt) => {\n            evt.preventDefault();\n        });\n        modal.body.css({\n            'display': 'flex',\n            'height': 'calc(90vh - 200px)',\n            'flex-grow': '1',\n            'overflow': 'hidden',\n        });\n        // Override styles imposed by body.tox-fullscreen on modals\n        modal.header.css({\n            'height': '61.46px',\n            'padding': '1rem 1rem',\n        });\n\n        const modalContent = this.modal.getRoot().find('.modal-content');\n        const isDark = getPref('theme') === 'dark';\n        if (isDark) {\n            modalContent.addClass('tiny_codepro-dark');\n        } else {\n            modalContent.removeClass('tiny_codepro-dark');\n        }\n\n        this.#bindActions();\n\n        if (getPref('fs')) {\n           // Set fullscreen mode\n           this.modal.header.hide();\n           const $dlgElem = this.modal.getRoot().find(dialogQuery);\n           $dlgElem.removeClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n           $dlgElem.addClass(\"tiny_codepro-fullscreen\");\n        }\n    }\n\n    #bindActions() {\n        const modalContent = this.modal.getRoot().find('.modal-content')[0];\n        // Setting references to Dom elements\n        this.domElements = {\n            root: modalContent,\n            btnTheme: this.modal.footer.find(\"button.btn[data-action='theme']\")[0],\n            btnWrap: this.modal.footer.find(\"button.btn[data-action='wrap']\")[0],\n        };\n\n        this.modal.footer.find(\"button.btn[data-action]\").on(\"click\", (evt) => {\n            const btnElem = evt.currentTarget;\n            const actionName = btnElem.dataset.action;\n            switch (actionName) {\n                case (\"view\"):\n                    this.switchViews();\n                    break;\n                case (\"fs\"):\n                    this.#toggleFullscreen();\n                    break;\n                case (\"font-\"):\n                    this.decreaseFontsize();\n                    break;\n                case (\"font+\"):\n                    this.increaseFontsize();\n                    break;\n                case (\"theme\"):\n                    this.toggleTheme();\n                    break;\n                case (\"wrap\"):\n                    this.toggleLineWrapping();\n                    break;\n                case (\"prettify\"):\n                    this.prettify();\n                    break;\n                case (\"cancel\"):\n                    this.close();\n                    break;\n                case (\"save\"):\n                    this.accept();\n                    break;\n            }\n        });\n    }\n\n    #toggleFullscreen() {\n        const $dlgElem = this.modal.getRoot().find(dialogQuery);\n        const isFullscreen = getPref(\"fs\", false);\n        if (!isFullscreen) {\n            // Set fullscreen mode\n            this.modal.header.hide();\n            $dlgElem.removeClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n            $dlgElem.addClass(\"tiny_codepro-fullscreen\");\n        } else {\n            // Set to modal-lg\n            this.modal.header.show();\n            $dlgElem.removeClass(\"tiny_codepro-fullscreen\");\n            $dlgElem.addClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n        }\n        setPref(\"fs\", !isFullscreen);\n    }\n\n    #unbindActions() {\n        this.modal.footer.find(\"button.btn[data-action]\").off(\"click\");\n    }\n\n    _tClose() {\n        this.#unbindActions();\n        this.modal.destroy();\n    }\n}\n"],"names":["dialogQuery","ViewDialogManager","ViewManager","constructor","editor","opts","modal","show","_showSpinner","this","body","attachCodeEditor","_hideSpinner","codeEditor","_config","lineWrapping","domElements","btnWrap","querySelector","innerHTML","icons","rightarrow","themeName","btnTheme","moon","canuserswitchui","startsWith","data","elementid","Math","random","toString","substring","templateContext","codeEditorElement","getRoot","find","addClass","off","on","ModalEvents","outsideClick","evt","preventDefault","css","header","modalContent","removeClass","bindActions","hide","$dlgElem","root","footer","currentTarget","dataset","action","switchViews","toggleFullscreen","decreaseFontsize","increaseFontsize","toggleTheme","toggleLineWrapping","prettify","close","accept","isFullscreen","_tClose","unbindActions","destroy"],"mappings":";;;;;;;yKA4BMA,YAAc,iDAEPC,0BAA0BC,yBACnCC,YAAYC,OAAQC,YACVD,OAAQC,0BAITC,MAAMC,YACNC,aAAaC,KAAKH,MAAMI,KAAK,UAE5BD,KAAKE,iBAAiBF,KAAKH,MAAMI,KAAK,SACvCE,aAAaH,KAAKH,MAAMI,KAAK,IAG7BD,KAAKI,WAAWC,QAAQC,oBACpBC,YAAYC,QAAQC,cAAc,QAAQC,UAAYjB,yBAAYkB,MAAMC,YAEvC,SAAtCZ,KAAKI,WAAWC,QAAQQ,iBACnBN,YAAYO,SAASL,cAAc,QAAQC,UAAYjB,yBAAYkB,MAAMI,6BAM5EC,kBADY,yBAAahB,KAAKL,SAAW,UACbsB,WAAW,SAEvCC,KAAO,CACTC,UAAWC,KAAKC,SAASC,SAAS,IAAIC,UAAU,GAChDP,gBAAAA,gBACAL,MAAOlB,yBAAYkB,OAIjBd,YAAc,sBAAY,CAC5B2B,gBAAiBN,YAEhBrB,MAAQA,WAER4B,kBAAoB5B,MAAMI,KAAK,GAEpCJ,MAAM6B,UAAUC,KAAK,0BAA0BC,SAAS,oBAExD/B,MAAM6B,UAAUG,IAAI,WAEpBhC,MAAM6B,UAAUI,GAAGC,sBAAYC,cAAeC,MAC1CA,IAAIC,oBAERrC,MAAMI,KAAKkC,IAAI,SACA,cACD,iCACG,aACD,WAGhBtC,MAAMuC,OAAOD,IAAI,QACH,kBACC,oBAGTE,aAAerC,KAAKH,MAAM6B,UAAUC,KAAK,qBACX,UAArB,wBAAQ,SAEnBU,aAAaT,SAAS,qBAEtBS,aAAaC,YAAY,2BAGxBC,eAED,wBAAQ,MAAO,MAEX1C,MAAMuC,OAAOI,aACZC,SAAWzC,KAAKH,MAAM6B,UAAUC,KAAKpC,aAC3CkD,SAASH,YAAY,iDACrBG,SAASb,SAAS,iDAKfS,aAAerC,KAAKH,MAAM6B,UAAUC,KAAK,kBAAkB,QAE5DpB,YAAc,CACfmC,KAAML,aACNvB,SAAUd,KAAKH,MAAM8C,OAAOhB,KAAK,mCAAmC,GACpEnB,QAASR,KAAKH,MAAM8C,OAAOhB,KAAK,kCAAkC,SAGjE9B,MAAM8C,OAAOhB,KAAK,2BAA2BG,GAAG,SAAUG,aAC3CA,IAAIW,cACOC,QAAQC,YAEzB,YACGC,wBAEH,WACGC,6BAEH,aACGC,6BAEH,aACGC,6BAEH,aACGC,wBAEH,YACGC,+BAEH,gBACGC,qBAEH,cACGC,kBAEH,YACGC,uCAOXd,SAAWzC,KAAKH,MAAM6B,UAAUC,KAAKpC,aACrCiE,cAAe,wBAAQ,MAAM,GAC9BA,mBAOI3D,MAAMuC,OAAOtC,OAClB2C,SAASH,YAAY,2BACrBG,SAASb,SAAS,wDAPb/B,MAAMuC,OAAOI,OAClBC,SAASH,YAAY,iDACrBG,SAASb,SAAS,qDAOd,MAAO4B,oCAIV3D,MAAM8C,OAAOhB,KAAK,2BAA2BE,IAAI,SAG1D4B,gBACSC,qBACA7D,MAAM8D"}