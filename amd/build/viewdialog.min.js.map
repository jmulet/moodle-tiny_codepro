{"version":3,"file":"viewdialog.min.js","sources":["../src/viewdialog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {createModal} from \"./modal\";\nimport ModalEvents from 'core/modal_events';\nimport {getPref, setPref} from \"./preferences\";\nimport {getDefaultUI} from \"./options\";\nimport {ViewManager} from \"./viewmanager\";\n\n/**\n * Tiny CodePro plugin.\n *\n * @module      tiny_codepro/plugin\n * @copyright   2023-2025 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nconst dialogQuery = '[role=\"document\"], [data-region=\"modal\"]';\n\nexport class ViewDialogManager extends ViewManager {\n    constructor(editor, opts) {\n        super(editor, opts);\n    }\n    async _tShow() {\n        // Make the modal visible\n        this.modal.show();\n        // Add the codeEditor (CodeMirror) in the selected UI element\n        await this.attachCodeEditor(this.codeEditorElement);\n        // Obtain the code from Tiny and set it to code editor\n        this.setHTMLCodeOrState();\n    }\n\n    async _tCreate() {\n        const defaultUI = getDefaultUI(this.editor) ?? 'dialog';\n        const canUserSwitchUI = defaultUI.startsWith('user:');\n\n        const data = {\n            elementid: Math.random().toString(32).substring(2),\n            canUserSwitchUI,\n            icons: ViewManager.icons\n        };\n\n        // Show modal with buttons.\n        const modal = await createModal({\n            templateContext: data,\n        });\n        this.modal = modal;\n\n        this.codeEditorElement = modal.body.find('.tiny_codepro-editor-area')[0];\n\n        modal.getRoot().find(\".modal-dialog.modal-lg\").addClass(\"tiny_codepro-dlg\");\n        // Disable keyboard events (ESC key) on this modal\n        modal.getRoot().off('keydown');\n        // Prevent modal from closing on outside clicks\n        modal.getRoot().on(ModalEvents.outsideClick, (evt) => {\n            evt.preventDefault();\n        });\n        modal.body.css(\"overflow\", \"hidden\");\n        // Override styles imposed by body.tox-fullscreen on modals\n        modal.header.css('height', '61.46px');\n        modal.header.css('padding', '1rem 1rem');\n\n        const modalContent = this.modal.getRoot().find('.modal-content');\n        const isDark = getPref('theme') === 'dark';\n        if (isDark) {\n            modalContent.addClass('tiny_codepro-dark');\n        } else {\n            modalContent.removeClass('tiny_codepro-dark');\n        }\n\n        this.#bindActions();\n\n        if (getPref('fs')) {\n           // Set fullscreen mode\n           this.modal.header.hide();\n           const $dlgElem = this.modal.getRoot().find(dialogQuery);\n           $dlgElem.removeClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n           $dlgElem.addClass(\"tiny_codepro-fullscreen\");\n        }\n    }\n\n    #bindActions() {\n        const modalContent = this.modal.getRoot().find('.modal-content')[0];\n        this.modal.footer.find(\"button.btn[data-action]\").on(\"click\", (evt) => {\n            const btnElem = evt.currentTarget;\n            const actionName = btnElem.dataset.action;\n            switch (actionName) {\n                case (\"view\"):\n                    this.switchViews();\n                    break;\n                case (\"fs\"):\n                    this.#toggleFullscreen();\n                    break;\n                case (\"font-\"):\n                    this.decreaseFontsize();\n                    break;\n                case (\"font+\"):\n                    this.increaseFontsize();\n                    break;\n                case (\"theme\"):\n                    this.toggleTheme(btnElem, modalContent);\n                    break;\n                case (\"wrap\"):\n                    this.toggleLineWrapping(btnElem);\n                    break;\n                case (\"prettify\"):\n                    this.prettify();\n                    break;\n                case (\"cancel\"):\n                    this.close();\n                    break;\n                case (\"save\"):\n                    this.accept();\n                    break;\n            }\n        });\n    }\n\n    #toggleFullscreen() {\n        const $dlgElem = this.modal.getRoot().find(dialogQuery);\n        const isFullscreen = getPref(\"fs\", false);\n        if (!isFullscreen) {\n            // Set fullscreen mode\n            this.modal.header.hide();\n            $dlgElem.removeClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n            $dlgElem.addClass(\"tiny_codepro-fullscreen\");\n        } else {\n            // Set to modal-lg\n            this.modal.header.show();\n            $dlgElem.removeClass(\"tiny_codepro-fullscreen\");\n            $dlgElem.addClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n        }\n        setPref(\"fs\", !isFullscreen, true);\n    }\n\n    #unbindActions() {\n        this.modal.footer.find(\"button.btn[data-action]\").off(\"click\");\n    }\n\n    _tClose() {\n        this.#unbindActions();\n        this.modal.destroy();\n    }\n}\n"],"names":["dialogQuery","ViewDialogManager","ViewManager","constructor","editor","opts","modal","show","this","attachCodeEditor","codeEditorElement","setHTMLCodeOrState","canUserSwitchUI","startsWith","data","elementid","Math","random","toString","substring","icons","templateContext","body","find","getRoot","addClass","off","on","ModalEvents","outsideClick","evt","preventDefault","css","header","modalContent","removeClass","bindActions","hide","$dlgElem","footer","btnElem","currentTarget","dataset","action","switchViews","toggleFullscreen","decreaseFontsize","increaseFontsize","toggleTheme","toggleLineWrapping","prettify","close","accept","isFullscreen","_tClose","unbindActions","destroy"],"mappings":";;;;;;;yKA4BMA,YAAc,iDAEPC,0BAA0BC,yBACnCC,YAAYC,OAAQC,YACVD,OAAQC,0BAITC,MAAMC,aAELC,KAAKC,iBAAiBD,KAAKE,wBAE5BC,4CAKCC,kBADY,yBAAaJ,KAAKJ,SAAW,UACbS,WAAW,SAEvCC,KAAO,CACTC,UAAWC,KAAKC,SAASC,SAAS,IAAIC,UAAU,GAChDP,gBAAAA,gBACAQ,MAAOlB,yBAAYkB,OAIjBd,YAAc,sBAAY,CAC5Be,gBAAiBP,YAEhBR,MAAQA,WAERI,kBAAoBJ,MAAMgB,KAAKC,KAAK,6BAA6B,GAEtEjB,MAAMkB,UAAUD,KAAK,0BAA0BE,SAAS,oBAExDnB,MAAMkB,UAAUE,IAAI,WAEpBpB,MAAMkB,UAAUG,GAAGC,sBAAYC,cAAeC,MAC1CA,IAAIC,oBAERzB,MAAMgB,KAAKU,IAAI,WAAY,UAE3B1B,MAAM2B,OAAOD,IAAI,SAAU,WAC3B1B,MAAM2B,OAAOD,IAAI,UAAW,mBAEtBE,aAAe1B,KAAKF,MAAMkB,UAAUD,KAAK,qBACX,UAArB,wBAAQ,SAEnBW,aAAaT,SAAS,qBAEtBS,aAAaC,YAAY,2BAGxBC,eAED,wBAAQ,MAAO,MAEX9B,MAAM2B,OAAOI,aACZC,SAAW9B,KAAKF,MAAMkB,UAAUD,KAAKvB,aAC3CsC,SAASH,YAAY,iDACrBG,SAASb,SAAS,iDAKfS,aAAe1B,KAAKF,MAAMkB,UAAUD,KAAK,kBAAkB,QAC5DjB,MAAMiC,OAAOhB,KAAK,2BAA2BI,GAAG,SAAUG,YACrDU,QAAUV,IAAIW,qBACDD,QAAQE,QAAQC,YAEzB,YACGC,wBAEH,WACGC,6BAEH,aACGC,6BAEH,aACGC,6BAEH,aACGC,YAAYR,QAASN,wBAExB,YACGe,mBAAmBT,mBAEtB,gBACGU,qBAEH,cACGC,kBAEH,YACGC,uCAOXd,SAAW9B,KAAKF,MAAMkB,UAAUD,KAAKvB,aACrCqD,cAAe,wBAAQ,MAAM,GAC9BA,mBAOI/C,MAAM2B,OAAO1B,OAClB+B,SAASH,YAAY,2BACrBG,SAASb,SAAS,wDAPbnB,MAAM2B,OAAOI,OAClBC,SAASH,YAAY,iDACrBG,SAASb,SAAS,qDAOd,MAAO4B,cAAc,yBAIxB/C,MAAMiC,OAAOhB,KAAK,2BAA2BG,IAAI,SAG1D4B,gBACSC,qBACAjD,MAAMkD"}