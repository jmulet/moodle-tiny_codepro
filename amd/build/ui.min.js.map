{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport CodeProModal from \"./modal\";\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {baseUrl} from './common';\nimport {getPref, setPref} from \"./preferences\";\n\n/**\n * Tiny CodePro plugin.\n *\n * @module      tiny_codepro/plugin\n * @copyright   2023 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nconst dialogQuery = '[role=\"document\"], [data-region=\"modal\"]';\nlet modal = null;\nlet codeEditorInstance = null;\n\n/**\n * Utility to toggle a class in an HTML element\n * @param {HTMLElement} el - The Element\n * @param {string[]} classList\n */\nconst toggleClasses = function(el, classList) {\n    const cl = el.classList;\n    classList.forEach(className => {\n        cl.toggle(className);\n    });\n};\n\n/**\n * Handle action\n * @param {TinyMCE} editor\n */\nexport const handleAction = (editor) => {\n    if (modal === null) {\n        createDialogue(editor);\n    } else {\n        modal.show();\n        codeEditorInstance.setValue(editor.getContent());\n    }\n};\n\nconst createDialogue = async(editor) => {\n    const data = {\n        elementid: editor.id\n    };\n\n    // Show modal with buttons.\n    modal = await ModalFactory.create({\n        type: CodeProModal.TYPE,\n        templateContext: data,\n        large: true,\n    });\n    modal.getRoot().find(\".modal-dialog.modal-lg\").css(\"max-width\", \"85%\");\n    // Disable ESC key on this modal\n    modal.getRoot().off('keydown');\n    modal.body.css(\"overflow-y\", \"overlay\");\n\n    // Load cm6 on demand\n    require.config({\n        paths: {\n            cm6pro: baseUrl + '/libs/codemirror/dist/cm6pro.min'\n        }\n    });\n    require(['cm6pro'], (CodeProEditor) => {\n        const targetElem = modal.body.find('.tiny_codepro-editor-area')[0];\n        codeEditorInstance = new CodeProEditor(targetElem);\n\n        modal.footer.find(\"button.btn[data-action]\").on(\"click\", (evt) => {\n            if (evt.target.classList.contains(\"btn-primary\")) {\n                const updatedCode = codeEditorInstance.getValue();\n                editor.setContent(updatedCode);\n            }\n            modal.hide();\n            // Delete content\n            codeEditorInstance.setValue();\n        });\n        modal.footer.find(\"button.btn.btn-light\").on(\"click\", (evt) => {\n            evt.preventDefault();\n            const ds = evt.currentTarget.dataset;\n            const icon = evt.currentTarget.querySelector(\"i.fa\");\n            const $dlgElem = modal.getRoot().find(dialogQuery);\n            if (ds.fs) {\n                if (ds.fs === \"false\") {\n                    // Set fullscreen mode\n                    ds.fs = \"true\";\n                    modal.header.hide();\n                    $dlgElem.removeClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n                    $dlgElem.addClass(\"tiny_codepro-fullscreen\");\n                } else {\n                    // Set to modal-lg\n                    ds.fs = \"false\";\n                    modal.header.show();\n                    $dlgElem.removeClass(\"tiny_codepro-fullscreen\");\n                    $dlgElem.addClass(\"modal-dialog modal-lg modal-dialog-scrollable\");\n                }\n                setPref(\"fs\", ds.fs, true);\n            } else if (ds.theme) {\n                if (ds.theme === \"light\") {\n                    ds.theme = \"dark\";\n                    codeEditorInstance.setTheme(\"dark\");\n                    $dlgElem.addClass(\"tiny_codepro-dark\");\n                } else {\n                    ds.theme = \"light\";\n                    codeEditorInstance.setTheme(\"light\");\n                    $dlgElem.removeClass(\"tiny_codepro-dark\");\n                }\n                toggleClasses(icon, [\"fa-sun-o\", \"fa-moon-o\"]);\n                setPref(\"theme\", ds.theme, true);\n            } else if (ds.wrap) {\n                if (ds.wrap === \"true\") {\n                    ds.wrap = false;\n                    codeEditorInstance.setLineWrapping(false);\n                } else {\n                    ds.wrap = true;\n                    codeEditorInstance.setLineWrapping(true);\n                }\n                setPref(\"wrap\", ds.wrap, true);\n                toggleClasses(icon, [\"fa-exchange\", \"fa-long-arrow-right\"]);\n            } else if (ds.prettify) {\n                codeEditorInstance.prettify();\n            }\n        });\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            codeEditorInstance.setValue();\n        });\n\n        // Setting stored preferences\n        const currentTheme = getPref(\"theme\", \"light\");\n        const currentWrap = getPref(\"wrap\", \"false\");\n        const currentFs = getPref(\"fs\", \"false\");\n        if (currentTheme !== \"light\") {\n            modal.footer.find(\"button.btn.btn-light[data-theme]\").click();\n        }\n        if (currentWrap === \"true\") {\n            modal.footer.find(\"button.btn.btn-light[data-wrap]\").click();\n        }\n        if (currentFs === \"true\") {\n            modal.footer.find(\"button.btn.btn-light[data-fs]\").click();\n        }\n\n        modal.show();\n        codeEditorInstance.setValue(editor.getContent());\n    });\n};"],"names":["modal","codeEditorInstance","toggleClasses","el","classList","cl","forEach","className","toggle","editor","createDialogue","show","setValue","getContent","async","data","elementid","id","ModalFactory","create","type","CodeProModal","TYPE","templateContext","large","getRoot","find","css","off","body","require","config","paths","cm6pro","baseUrl","CodeProEditor","targetElem","footer","on","evt","target","contains","updatedCode","getValue","setContent","hide","preventDefault","ds","currentTarget","dataset","icon","querySelector","$dlgElem","fs","header","removeClass","addClass","theme","setTheme","wrap","setLineWrapping","prettify","ModalEvents","hidden","currentTheme","currentWrap","currentFs","click"],"mappings":";;;;;;;8OA6BIA,MAAQ,KACRC,mBAAqB,WAOnBC,cAAgB,SAASC,GAAIC,iBACzBC,GAAKF,GAAGC,UACdA,UAAUE,SAAQC,YACdF,GAAGG,OAAOD,qCAQWE,SACX,OAAVT,MACAU,eAAeD,SAEfT,MAAMW,OACNV,mBAAmBW,SAASH,OAAOI,sBAIrCH,eAAiBI,MAAAA,eACbC,KAAO,CACTC,UAAWP,OAAOQ,IAItBjB,YAAckB,uBAAaC,OAAO,CAC9BC,KAAMC,eAAaC,KACnBC,gBAAiBR,KACjBS,OAAO,IAEXxB,MAAMyB,UAAUC,KAAK,0BAA0BC,IAAI,YAAa,OAEhE3B,MAAMyB,UAAUG,IAAI,WACpB5B,MAAM6B,KAAKF,IAAI,aAAc,WAG7BG,QAAQC,OAAO,CACXC,MAAO,CACHC,OAAQC,gBAAU,sCAG1BJ,QAAQ,CAAC,WAAYK,sBACXC,WAAapC,MAAM6B,KAAKH,KAAK,6BAA6B,GAChEzB,mBAAqB,IAAIkC,cAAcC,YAEvCpC,MAAMqC,OAAOX,KAAK,2BAA2BY,GAAG,SAAUC,SAClDA,IAAIC,OAAOpC,UAAUqC,SAAS,eAAgB,OACxCC,YAAczC,mBAAmB0C,WACvClC,OAAOmC,WAAWF,aAEtB1C,MAAM6C,OAEN5C,mBAAmBW,cAEvBZ,MAAMqC,OAAOX,KAAK,wBAAwBY,GAAG,SAAUC,MACnDA,IAAIO,uBACEC,GAAKR,IAAIS,cAAcC,QACvBC,KAAOX,IAAIS,cAAcG,cAAc,QACvCC,SAAWpD,MAAMyB,UAAUC,KApEzB,4CAqEJqB,GAAGM,IACW,UAAVN,GAAGM,IAEHN,GAAGM,GAAK,OACRrD,MAAMsD,OAAOT,OACbO,SAASG,YAAY,iDACrBH,SAASI,SAAS,6BAGlBT,GAAGM,GAAK,QACRrD,MAAMsD,OAAO3C,OACbyC,SAASG,YAAY,2BACrBH,SAASI,SAAS,2EAEd,KAAMT,GAAGM,IAAI,IACdN,GAAGU,OACO,UAAbV,GAAGU,OACHV,GAAGU,MAAQ,OACXxD,mBAAmByD,SAAS,QAC5BN,SAASI,SAAS,uBAElBT,GAAGU,MAAQ,QACXxD,mBAAmByD,SAAS,SAC5BN,SAASG,YAAY,sBAEzBrD,cAAcgD,KAAM,CAAC,WAAY,uCACzB,QAASH,GAAGU,OAAO,IACpBV,GAAGY,MACM,SAAZZ,GAAGY,MACHZ,GAAGY,MAAO,EACV1D,mBAAmB2D,iBAAgB,KAEnCb,GAAGY,MAAO,EACV1D,mBAAmB2D,iBAAgB,6BAE/B,OAAQb,GAAGY,MAAM,GACzBzD,cAAcgD,KAAM,CAAC,cAAe,yBAC7BH,GAAGc,UACV5D,mBAAmB4D,cAG3B7D,MAAMyB,UAAUa,GAAGwB,sBAAYC,QAAQ,KACnC9D,mBAAmBW,oBAIjBoD,cAAe,wBAAQ,QAAS,SAChCC,aAAc,wBAAQ,OAAQ,SAC9BC,WAAY,wBAAQ,KAAM,SACX,UAAjBF,cACAhE,MAAMqC,OAAOX,KAAK,oCAAoCyC,QAEtC,SAAhBF,aACAjE,MAAMqC,OAAOX,KAAK,mCAAmCyC,QAEvC,SAAdD,WACAlE,MAAMqC,OAAOX,KAAK,iCAAiCyC,QAGvDnE,MAAMW,OACNV,mBAAmBW,SAASH,OAAOI"}